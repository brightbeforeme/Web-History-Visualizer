<html>
  <head>
    <script src="lib/jquery.js"></script>
    <script src="lib/protovis.js"></script>
    <script src="lib/parseuri.js"></script>
    <script src="history.js"></script>
    <script src="visualizations.js"></script>
    <script src="util.js"></script>
    <script src="api.js"></script>
    <link rel="stylesheet" type="text/css" href="history.css" />
    <style type="text/css">
    </style>
  </head>
  <body>
    <div id="loading" style="margin:auto; width: 960px">
      Please wait, visualization loading...
      <img src="loading.gif" />
    </div>
    <div id="container" style="display:none">
      <div class="header">
        Browser History
      </div>
      <div class="nav" id="nav">
        <a href="javascript:void(0)" class="nav_link clickable_link" id="showHistory">Show History</a>
        <a href="javascript:void(0)" class="nav_link clickable_link" id="pagesPerDay">Number of Pages Per Day</a>
        <a href="javascript:void(0)" class="nav_link clickable_link" id="mostVisited">Most visited websites</a>
        <a href="javascript:void(0)" class="nav_link" id="tempLink">TEMP</a>
      </div>
      <div class="chart_title">
        Number of Visits per Day
      </div>
      <div class="chart_links">
        change to: <a href="javascript:void(0)" id="hourScale">hour</a> |
        <a href="javascript:void(0)" id="dayScale">day</a> |
        <a href="javascript:void(0)" id="monthScale">month</a> |
        <a href="javascript:void(0)" id="yearScale">year</a>
      </div>
      <script type="text/javascript+protovis">
      
      function renderTopDomains() {
        var numDomainsToShow = 8;
        var numVisits = numVisitsByURL(getVisits());
        var sorted = hashToArray(numVisits, true).slice(-numDomainsToShow);
        /*
        for (var i in sorted) {
          $("#results").append(sorted[i].key + ": " + sorted[i].val + "<br/>");
        }
        */
        
        
        var td_data = pv.range(numDomainsToShow).map(function(d) { 
          if(sorted[d] === undefined) {
            return 0;
          }
          return sorted[d].val;
        });
        /* Sizing and scales. */
        w_bar = 700;
        h_bar = 300;
        //x_bar = pv.Scale.linear(0, 1500).range(0, w_bar);
        x_bar = pv.Scale.linear(td_data, function(d) d).range(0, w_bar);
        y_bar = pv.Scale.ordinal(pv.range(numDomainsToShow)).splitBanded(0, h_bar, 4/5);
        
        /* The root panel. */
        topDomains = new pv.Panel()
            .width(w_bar)
            .height(h_bar)
            .bottom(20)
            .left(150)
            .right(10)
            .top(5);
        
        /* The bars. */
        var bar = topDomains.add(pv.Bar)
            .data(td_data)
            .top(function() y_bar(this.index))
            .height(y_bar.range().band)
            .left(0)
            .cursor("pointer")
            .event("mouseover", function() this.fillStyle("#0a4"))
            .event("mouseout", function() this.fillStyle("#27f"))
            .event("click", function() alert(sorted[this.index].key + " - TODO: show some cool stuff"))
            .width(x_bar);
        
        /* The value label. */
        bar.anchor("left").add(pv.Label)
            .textStyle("black")
            .text(function(d) d.toFixed(1));
        
        /* The variable label. */
        bar.anchor("left").add(pv.Label)
            .textMargin(5)
            .textAlign("right")
            .text(function() sorted[this.index].key);
        
        /* X-axis ticks. */
        topDomains.add(pv.Rule)
            .data(x_bar.ticks(5))
            .left(x_bar)
            .strokeStyle(function(d) d ? "rgba(255,255,255,.3)" : "#000")
          .add(pv.Rule)
            .bottom(0)
            .height(5)
            .strokeStyle("#000")
          .anchor("bottom").add(pv.Label)
            .text(x_bar.tickFormat);
        
        topDomains.render();
      }
      
        function renderNumVisitsGraph() {
          numVisits = numVisitsByTime(getVisits(), TimeScale.DAY);
          data = pv.range(1, 32, 1).map(function(x) {
            var i = numVisits[x];
            if(i === undefined) {
              i = 0;
            }
            return {x: x, y: i};
          });
          /* Sizing and scales. */
          w = 400;
          h = 200;
          x = pv.Scale.linear(data, function(d) d.x).range(0, w);
          y = pv.Scale.linear(data, function(d) d.y).range(0, h);
          
          /* The root panel. */
          vis = new pv.Panel()
            .width(w)
            .height(h)
            .bottom(20)
            .left(40)
            .right(10)
            .top(5);
          
          /* Y-axis and ticks. */
          vis.add(pv.Rule)
            .data(y.ticks(10))
            .bottom(y)
            .strokeStyle(function(d) d ? "#ccc" : "#000")
            .anchor("left").add(pv.Label)
            .text(y.tickFormat);
          
          /* X-axis and ticks. */
          /*
          xRule = vis.add(pv.Rule);
          awef = xRule.data(x.ticks(10))
            .visible(function(d) d)
            .left(x)
            .bottom(-5)
            .height(5)
            .anchor("bottom");
          xText = awef.add(pv.Label).text(x.tickFormat);
          */
          
          vis.add(pv.Rule)
            .data(x.ticks(10))
            //.visible(function(d) d > 5)
            //.strokeStyle("#f00")
            .left(x)
            .bottom(-5)
            .height(5)
            .anchor("bottom").add(pv.Label)
            .text(x.tickFormat);
          
          /* The area with top line. */
          areaData = vis.add(pv.Area);
            areaData.data(data)
            .bottom(1)
            .left(function(d) x(d.x))
            .height(function(d) y(d.y))
            .fillStyle("rgb(121,173,210)")
            .anchor("top");
          
          vis.render();
        }
        
        //renders the graph with a focus on a particular domain
        function renderFocusGraph() {
          //var domainName = "www.reddit.com"; //TODO: change this dynamically based on user input
          var domainFilter = {"domain": "www.reddit.com"};
        
          numVisitsFocus = numVisitsByTime(getVisits(domainFilter), TimeScale.HOUR);
          focusData = pv.range(0, 24, 1).map(function(x) {
            var i = numVisitsFocus[x];
            if(i === undefined) {
              i = 0;
            }
            return {x: x, y: i};
          });
          
          /* Sizing and scales. */
          w_foc = 400;
          h_foc = 200;
          x_foc = pv.Scale.linear(focusData, function(d) d.x).range(0, w_foc);
          y_foc = pv.Scale.linear(focusData, function(d) d.y).range(0, h_foc);
          
          /* The root panel. */
          focusVis = new pv.Panel()
            .width(w_foc)
            .height(h_foc)
            .bottom(20)
            .left(40)
            .right(10)
            .top(5);
          
          /* Y-axis and ticks. */
          focusVis.add(pv.Rule)
            .data(y_foc.ticks(10))
            .bottom(y_foc)
            .strokeStyle(function(d) d ? "#ccc" : "#000")
            .anchor("left").add(pv.Label)
            .text(y_foc.tickFormat);
          
          /* X-axis and ticks. */
          focusVis.add(pv.Rule)
            .data(x_foc.ticks(10))
            //.visible(function(d) d > 5)
            //.strokeStyle("#ccc")
            .left(x_foc)
            .bottom(-5)
            .height(5)
            .anchor("bottom").add(pv.Label)
            .text(x_foc.tickFormat);
          
          /* The area with top line. */
          focusVis.add(pv.Area)
            .data(focusData)
            .bottom(1)
            .left(function(d) x_foc(d.x))
            .height(function(d) y_foc(d.y))
            .fillStyle("#3a5")
            .anchor("top");
          
          focusVis.render();
        }
        
        //renders the graph with a focus on a particular domain
        function renderComparisonGraph() {
          //var domainName = "www.reddit.com"; //TODO: change this dynamically based on user input
          var domainFilter = {"domain": "www.reddit.com"};
        
          numVisitsCompare = numVisitsByTime(getVisits(domainFilter), TimeScale.HOUR);
          compareData = pv.range(2).map(function() {
            return pv.range(0, 24, 1).map(function(x) {
              var i = numVisitsCompare[x];
              if(i === undefined) {
                i = 0;
              }
              return {x: x, y: i};
            });
          });
          
          /* Sizing and scales. */
          w_com = 400;
          h_com = 200;
          x_com = pv.Scale.linear(compareData, function(d) d.x).range(0, w_com);
          y_com = pv.Scale.linear(compareData, function(d) d.y).range(0, h_com);
          
          /* The root panel. */
          compareVis = new pv.Panel()
            .width(w_com)
            .height(h_com)
            .bottom(20)
            .left(40)
            .right(10)
            .top(5);
          
          /* Y-axis and ticks. */
          compareVis.add(pv.Rule)
            .data(y_com.ticks(10))
            .bottom(y_com)
            .strokeStyle(function(d) d ? "#ccc" : "#000")
            .anchor("left").add(pv.Label)
            .text(y_com.tickFormat);
          
          /* X-axis and ticks. */
          compareVis.add(pv.Rule)
            .data(x_com.ticks(10))
            //.visible(function(d) d > 5)
            //.strokeStyle("#ccc")
            .left(x_com)
            .bottom(-5)
            .height(5)
            .anchor("bottom").add(pv.Label)
            .text(x_com.tickFormat);
          
          /* The area with top line. */
          compareVis.add(pv.Area)
            .data(compareData)
            .bottom(1)
            .left(function(d) x_com(d.x))
            .height(function(d) y_com(d.y))
            .fillStyle("#3a5")
            .anchor("top");
          
          compareVis.render();
        }
        
        function renderPingsGraph() {
          var minTime = 1290000000000;
          var maxTime = minTime + (86400 * 1000); //86400 = seconds per day
          var range = maxTime - minTime;
        
          var domainString1 = "www.reddit.com";
          var domainFilter1 = {"domain": domainString1, "minTime": minTime, "maxTime": maxTime};
          pings1 = getVisits(domainFilter1);
          
          var domainString2 = "mail.google.com";
          var domainFilter2 = {"domain": domainString2, "minTime": minTime, "maxTime": maxTime};
          pings2 = getVisits(domainFilter2);
          
          dataAwesome = pv.range(0, pings1.length + pings2.length, 1).map(function(x) {
            if(x < pings1.length) {
              var timeVar = pings1[x].time;
              timeVar -= minTime;
              timeVar = timeVar / range;
              return {x: timeVar, y: 30, z: 10, w: 1};
            }
            else {
              var timeVar = pings2[x - pings1.length].time;
              timeVar -= minTime;
              timeVar = timeVar / range;
              return {x: timeVar, y: 15, z: 10, w: 99};
            }
          });
          
          var w = 800,
          h = 200,
          x = pv.Scale.linear(0, 1).range(0, w),
          y = pv.Scale.linear(0, 50).range(0, h),
          c = pv.Scale.log(1, 100).range("blue", "red");

          /* The root panel. */
          var visAwesome = new pv.Panel()
              .width(w)
              .height(h)
              .bottom(20)
              .left(100)
              .right(10)
              .top(5);
           
          /* Y-axis and ticks. */
          var temp = visAwesome.add(pv.Rule)
              .data(y.ticks())
              .bottom(y)
              .strokeStyle(function(d) d ? "#eee" : "#000")
            .anchor("left");
            
            temp.add(pv.Label)
              .visible(function(d) d == 30)
              .text(domainString1);
              
            temp.add(pv.Label)
              .visible(function(d) d == 15)
              .text(domainString2);
          
          /* X-axis and ticks. */
          visAwesome.add(pv.Rule)
              .data(x.ticks())
              .left(x)
              .strokeStyle(function(d) d ? "#eee" : "#000")
            .anchor("bottom").add(pv.Label)
              .visible(function(d) d > 0 && d < 100)
              .text(x.tickFormat);
          
          /* The dot plot! */
          visAwesome.add(pv.Panel)
              .data(dataAwesome)
            .add(pv.Dot)
              .left(function(d) x(d.x))
              .bottom(function(d) y(d.y))
              .strokeStyle(function(d) c(d.w))
              .fillStyle(function() this.strokeStyle().alpha(.2))
              .size(function(d) d.z)
              .title(function(d) d.z.toFixed(1));
            
          visAwesome.render();
        }
        
        
        visitsReady(renderNumVisitsGraph);
        visitsReady(renderTopDomains);
        visitsReady(renderFocusGraph);
        visitsReady(renderPingsGraph);
        visitsReady(initFunc);
        
        function updateNumVisitsData(begin, end) {
          data = pv.range(begin, end, 1).map(function(x) {
            var i = numVisits[x];
            if(i === undefined) {
              i = 0;
            }
            return {x: x, y: i};
          });
          
          x = pv.Scale.linear(data, function(d) d.x).range(0, w);
          y = pv.Scale.linear(data, function(d) d.y).range(0, h);
          //TODO: have the axes change when data changes
          //xRule.data(x.ticks());
          //awef.data(x.ticks());
          //xText.text(x.tickFormat);
          //awef.add(pv.Label).text(x.tickFormat);
          areaData.data(data);
          areaData.render();
        }
        
        $('#hourScale').click(function() {
          numVisits = numVisitsByTime(getVisits(), TimeScale.HOUR);
          updateNumVisitsData(0, 24);
          $('#chart_title').html('Number of Visits per Hour');
        });
        $('#dayScale').click(function() {
          numVisits = numVisitsByTime(getVisits(), TimeScale.DAY);
          updateNumVisitsData(1, 32);
          $('#chart_title').html('Number of Visits per Day');
        });
        $('#monthScale').click(function() {
          numVisits = numVisitsByTime(getVisits(), TimeScale.MONTH);
          updateNumVisitsData(0, 12);
          $('#chart_title').html('Number of Visits per Month');
        });
        $('#yearScale').click(function() {
          numVisits = numVisitsByTime(getVisits(), TimeScale.YEAR);
          updateNumVisitsData(2007, 2012);
          $('#chart_title').html('Number of Visits per Year');
        });
      </script>
      <div id="results">
      </div>
    </div>
    <script type="text/javascript">
      function initFunc() {
        $('span').attr('class', 'protovisGraph');
        $('span').each(function(index) {
          if(index == 0) { $(this).attr('id', 'graph_time'); }
          else if(index == 1) { $(this).attr('id', 'graph_topDomains'); }
          else if(index == 2) { $(this).attr('id', 'graph_focus'); }
          else if(index == 3) { $(this).attr('id', 'graph_pings'); }
        });
        
        //time num visits graph
        $('#graph_time').appendTo('#container');
        $('#container').append('<p>(Todo: Axes must change when data changes)<\/p>');
        
        //spotlight focus graph
        $('#container').append('<div class="chart_title" style="margin-top:20px">Focus Graph: Spotlight on <a href="javascript:void(0)">reddit.com<\/a><\/div>');
        $('#container').append('<div>Hourly Usage<\/div>');
        $('#graph_focus').appendTo('#container');
        
        //top domains graph
        $('#container').append('<div class="chart_title" style="margin-top:20px">Top Domains<\/div>');
        $('#graph_topDomains').appendTo('#container');
        $('#loading').hide();
        $('#container').show();
        
        //pings graph
        $('#container').append('<div class="chart_title" style="margin-top:20px">Individual Visits to <a href="javascript:void(0)">reddit.com<\/a><\/div>');
        $('#graph_pings').appendTo('#container');
      }
      //setTimeout("initFunc();", 500);
    </script>
  </body>
</html>
