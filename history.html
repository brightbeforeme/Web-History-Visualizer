<html>
  <head>
    <script src="lib/jquery.js"></script>
    <script src="lib/protovis.js"></script>
    <script src="lib/parseuri.js"></script>
    <script src="history.js"></script>
    <script src="visualizations.js"></script>
    <script src="util.js"></script>
    <script src="api.js"></script>
    <link rel="stylesheet" type="text/css" href="history.css" />
    <style type="text/css">
    </style>
  </head>
  <body>
    <div id="loading" style="margin:auto; width: 960px">
      Please wait, visualization loading...
      <img src="loading.gif" />
    </div>
    <div id="container" style="display:none">
      <div class="header">
        Browser History
      </div>
      <div class="nav" id="nav">
        <a href="javascript:void(0)" class="nav_link clickable_link" id="showHistory">Show History</a>
        <a href="javascript:void(0)" class="nav_link clickable_link" id="pagesPerDay">Number of Pages Per Day</a>
        <a href="javascript:void(0)" class="nav_link clickable_link" id="mostVisited">Most visited websites</a>
      </div>
      <!--
      <div class="chart_title">
        Number of Visits per Day
      </div>
      <div class="chart_links">
        change to: <a href="javascript:void(0)" id="hourScale">hour</a> |
        <a href="javascript:void(0)" id="dayScale">day</a> |
        <a href="javascript:void(0)" id="monthScale">month</a> |
        <a href="javascript:void(0)" id="yearScale">year</a>
      </div>
      -->
      <script type="text/javascript+protovis">
      
      function renderTopDomains(out) {
        var numDomainsToShow = 8;
        var numVisits = numVisitsByURL(getVisits());
        var sorted = hashToArray(numVisits, true).slice(-numDomainsToShow);
        /*
        for (var i in sorted) {
          $("#results").append(sorted[i].key + ": " + sorted[i].val + "<br/>");
        }
        */
        
        
        var td_data = pv.range(numDomainsToShow).map(function(d) { 
          if(sorted[d] === undefined) {
            return 0;
          }
          return sorted[d].val;
        });
        /* Sizing and scales. */
        w_bar = 700;
        h_bar = 300;
        //x_bar = pv.Scale.linear(0, 1500).range(0, w_bar);
        x_bar = pv.Scale.linear(td_data, function(d) d).range(0, w_bar);
        y_bar = pv.Scale.ordinal(pv.range(numDomainsToShow)).splitBanded(0, h_bar, 4/5);
        
        /* The root panel. */
        topDomains = new pv.Panel()
            .width(w_bar)
            .height(h_bar)
            .bottom(20)
            .left(150)
            .right(10)
            .top(5)
            .canvas(out);
        
        /* The bars. */
        var bar = topDomains.add(pv.Bar)
            .data(td_data)
            .top(function() y_bar(this.index))
            .height(y_bar.range().band)
            .left(0)
            .cursor("pointer")
            .event("mouseover", function() this.fillStyle("#0a4"))
            .event("mouseout", function() this.fillStyle("#27f"))
            .event("click", function() alert(sorted[this.index].key + " - TODO: show some cool stuff"))
            .width(x_bar);
        
        /* The value label. */
        bar.anchor("left").add(pv.Label)
            .textStyle("black")
            .text(function(d) d.toFixed(1));
        
        /* The variable label. */
        bar.anchor("left").add(pv.Label)
            .textMargin(5)
            .textAlign("right")
            .text(function() sorted[this.index].key);
        
        /* X-axis ticks. */
        topDomains.add(pv.Rule)
            .data(x_bar.ticks(5))
            .left(x_bar)
            .strokeStyle(function(d) d ? "rgba(255,255,255,.3)" : "#000")
          .add(pv.Rule)
            .bottom(0)
            .height(5)
            .strokeStyle("#000")
          .anchor("bottom").add(pv.Label)
            .text(x_bar.tickFormat);
        
        topDomains.render();
      }
      
        function renderNumVisitsGraph(visits, out, timeScale, relative) {
          timeScale = timeScale || TimeScale.DAY;

          numVisits = numVisitsByTime(visits, timeScale, relative);
          data = pv.range(1, 32, 1).map(function(x) {
            var i = numVisits[x];
            if(i === undefined) {
              i = 0;
            }
            return {x: x, y: i};
          });
          /* Sizing and scales. */
          w = 400;
          h = 200;
          x = pv.Scale.linear(data, function(d) d.x).range(0, w);
          y = pv.Scale.linear(data, function(d) d.y).range(0, h);
          
          /* The root panel. */
          vis = new pv.Panel()
            .width(w)
            .height(h)
            .bottom(20)
            .left(40)
            .right(10)
            .top(5)
            .canvas(out);
          
          /* Y-axis and ticks. */
          vis.add(pv.Rule)
            .data(y.ticks(10))
            .bottom(y)
            .strokeStyle(function(d) d ? "#ccc" : "#000")
            .anchor("left").add(pv.Label)
            .text(y.tickFormat);
          
          /* X-axis and ticks. */
          /*
          xRule = vis.add(pv.Rule);
          awef = xRule.data(x.ticks(10))
            .visible(function(d) d)
            .left(x)
            .bottom(-5)
            .height(5)
            .anchor("bottom");
          xText = awef.add(pv.Label).text(x.tickFormat);
          */
          
          vis.add(pv.Rule)
            .data(x.ticks(10))
            //.visible(function(d) d > 5)
            //.strokeStyle("#f00")
            .left(x)
            .bottom(-5)
            .height(5)
            .anchor("bottom").add(pv.Label)
            .text(x.tickFormat);
          
          /* The area with top line. */
          areaData = vis.add(pv.Area);
            areaData.data(data)
            .bottom(1)
            .left(function(d) x(d.x))
            .height(function(d) y(d.y))
            .fillStyle("rgb(121,173,210)")
            .anchor("top");
          
          vis.render();
        }
        
        //END OLD CODE; begin NEW CODE
        //renders an area graph
        function renderAreaGraph(out, domainName, timeScale) {
            $('#container').append('<div class="chart_title" style="margin-top:20px">Focus Graph: Spotlight on <a href="javascript:void(0)">' + domainName + '<\/a><\/div>');
            $('#container').append('<div>Hourly Usage<\/div>');
            $('#graph_focus').appendTo('#container');

          var domainFilter = {};
          if(domainName) {
            domainFilter = {"domain": domainName};
          }
        
          var numVisits = numVisitsByTime(getVisits(domainFilter), timeScale);
          var graphData = pv.range(getTimeScaleMin(timeScale),
                                   getTimeScaleMax(timeScale),
                                   1).map(function(x) {
            var i = numVisits[x];
            if(i === undefined) {
              i = 0;
            }
            return {x: x, y: i};
          });
          
          /* Sizing and scales. */
          var w = 400;
          var h = 200;
          var x = pv.Scale.linear(graphData, function(d) d.x).range(0, w);
          var y = pv.Scale.linear(graphData, function(d) d.y).range(0, h);
          
          /* The root panel. */
          var areaVis = new pv.Panel()
            .width(w)
            .height(h)
            .bottom(20)
            .left(40)
            .right(10)
            .top(5)
            .canvas(out);
          
          /* Y-axis and ticks. */
          areaVis.add(pv.Rule)
            .data(y.ticks(10))
            .bottom(y)
            .strokeStyle(function(d) d ? "#ccc" : "#000")
            .anchor("left").add(pv.Label)
            .text(y.tickFormat);
          
          /* X-axis and ticks. */
          areaVis.add(pv.Rule)
            .data(x.ticks(10))
            //.visible(function(d) d > 5)
            //.strokeStyle("#ccc")
            .left(x)
            .bottom(-5)
            .height(5)
            .anchor("bottom").add(pv.Label)
            .text(x.tickFormat);
          
          /* The area with top line. */
          areaVis.add(pv.Area)
            .data(graphData)
            .bottom(1)
            .left(function(d) x(d.x))
            .height(function(d) y(d.y))
            .fillStyle("#a53")
            .anchor("top");
          
          areaVis.render();
        }
        
        //renders the timegraph
        function renderPingsGraph(out, minTime, maxTime, domains) {
          var range = maxTime - minTime;
          var totalPings = new Array();
          for(var i = 0; i < domains.length; i++) {
            var pingsList = getVisits({"domain":domains[i], "minTime": minTime, "maxTime": maxTime});
            totalPings = totalPings.concat(pingsList);
          }
          
          var colorScale = Math.floor(98 / (domains.length - 1));
          
          var pingsData = pv.range(0, totalPings.length, 1).map(function(x) {
            var y = 10;
            var color = 1;
            for(var i = 0; i < domains.length; i++) {
              if(totalPings[x].url.indexOf(domains[i]) >= 0) {
                break;
              }
              else {
                y += 10;
                color += colorScale;
              }
            }
            
            return {x: new Date(totalPings[x].time), y: y, z: 10, w: color};
          });
          
          var w_pin = 780,
          h_pin = (domains.length + 1) * 25,
          x_pin = pv.Scale.linear(new Date(minTime), new Date(maxTime)).range(0, w_pin),
          y_pin = pv.Scale.linear(0, domains.length * 10 + 10).range(0, h_pin),
          c_pin = pv.Scale.linear(1, 100).range("blue", "red");

          /* The root panel. */
          var pingsVis = new pv.Panel()
              .width(w_pin)
              .height(h_pin)
              .bottom(20)
              .left(140)
              .right(10)
              .top(5)
              .canvas(out);
           
          /* Y-axis and ticks. */
          var pingsVis_yAxis = pingsVis.add(pv.Rule)
              .data(y_pin.ticks())
              .bottom(y_pin)
              .strokeStyle(function(d) d ? "#eee" : "#000")
              .visible(function(d) d % 10 == 0)
              .anchor("left");
          
          
          pingsVis_yAxis.add(pv.Label)
              .visible(function(d) d == 10)
              .text(domains[0]);
          if(domains.length > 1) {
            pingsVis_yAxis.add(pv.Label)
              .visible(function(d) d == 20)
              .text(domains[1]);
          }
          if(domains.length > 2) {
            pingsVis_yAxis.add(pv.Label)
              .visible(function(d) d == 30)
              .text(domains[2]);
          }
          if(domains.length > 3) {
            pingsVis_yAxis.add(pv.Label)
              .visible(function(d) d == 40)
              .text(domains[3]);
          }
          if(domains.length > 4) {
            pingsVis_yAxis.add(pv.Label)
              .visible(function(d) d == 50)
              .text(domains[4]);
          }
          if(domains.length > 5) {
            pingsVis_yAxis.add(pv.Label)
              .visible(function(d) d == 60)
              .text(domains[5]);
          }
          if(domains.length > 6) {
            pingsVis_yAxis.add(pv.Label)
              .visible(function(d) d == 70)
              .text(domains[6]);
          }
          if(domains.length > 7) {
            pingsVis_yAxis.add(pv.Label)
              .visible(function(d) d == 80)
              .text(domains[7]);
          }
          
          /* X-axis and ticks. */
          pingsVis.add(pv.Rule)
              .data(x_pin.ticks())
              .left(x_pin)
              .strokeStyle(function(d) "#888")
            .anchor("bottom").add(pv.Label)
              .text(x_pin.tickFormat);
          
          /* The dot plot! */
          pingsVis_dots = pingsVis.add(pv.Panel)
              .data(pingsData)
            .add(pv.Dot)
              .left(function(d) x_pin(d.x))
              .bottom(function(d) y_pin(d.y))
              .strokeStyle(function(d) c_pin(d.w))
              .fillStyle(function() this.strokeStyle().alpha(.2))
              .size(function(d) d.z)
              .title(function(d) d.z.toFixed(1));
            
          pingsVis.render();
        }
        
        function refreshPingsGraph(out, minTime, maxTime) {
          $('#graph_pings').hide();
          $('#graph_pings').removeAttr('id');
          renderPingsGraph(out, minTime, maxTime, domainsList);
          $('span').last().attr('id', 'graph_pings');
          $('#graph_pings').appendTo('#container');
        }
        
        function updatePingsGraph_addDomain(out, newDomain) {
          var minTime = 1289900000000;
          var maxTime = minTime + (86400 * 1000); //86400 = seconds per day
          domainsList.push(newDomain);
          refreshPingsGraph(out, minTime, maxTime);
        }
        
        function updatePingsGraph_time(out, inyear, inmonth, inday) {
          var minTime = new Date(inyear, inmonth-1, inday).getTime();
          var maxTime = minTime + (86400 * 1000); //86400 = seconds per day
          refreshPingsGraph(out, minTime, maxTime);
          $('#pings_date').html('Visits for ' + inmonth + '-' + inday + '-' + inyear);
        }
        
        
        
        
        
        /*
        //BELOW METHODS FOR TESTING
        //these pass in hard-coded domains to the generic graph methods
        //we can make these dynamic (i.e. user input) later
        function renderReddit() {
          renderAreaGraph("www.reddit.com", TimeScale.DAY);
        }
        
        function renderDefaultPingsGraph() {
          var minTime = 1289900000000;
          var maxTime = minTime + (86400 * 1000); //86400 = seconds per day
          domainsList = new Array();
          domainsList.push("www.reddit.com");
          domainsList.push("mail.google.com");
          domainsList.push("facebook.com");
          renderPingsGraph(minTime, maxTime, domainsList);
        }
        */
        
        
        
        //INIT CODE
        /*
        visitsReady(renderNumVisitsGraph);
        visitsReady(renderTopDomains);
        visitsReady(renderReddit);
        visitsReady(renderDefaultPingsGraph);
        */
        visitsReady(initFunc);
        visitsReady(showHistory);
        
        function updateNumVisitsData(begin, end) {
          data = pv.range(begin, end, 1).map(function(x) {
            var i = numVisits[x];
            if(i === undefined) {
              i = 0;
            }
            return {x: x, y: i};
          });
          
          x = pv.Scale.linear(data, function(d) d.x).range(0, w);
          y = pv.Scale.linear(data, function(d) d.y).range(0, h);
          //TODO: have the axes change when data changes
          //xRule.data(x.ticks());
          //awef.data(x.ticks());
          //xText.text(x.tickFormat);
          //awef.add(pv.Label).text(x.tickFormat);
          areaData.data(data);
          areaData.render();
        }
        
        $('#hourScale').click(function() {
          numVisits = numVisitsByTime(getVisits(), TimeScale.HOUR);
          updateNumVisitsData(0, 24);
          $('#chart_title').html('Number of Visits per Hour');
        });
        $('#dayScale').click(function() {
          numVisits = numVisitsByTime(getVisits(), TimeScale.DAY);
          updateNumVisitsData(1, 32);
          $('#chart_title').html('Number of Visits per Day');
        });
        $('#monthScale').click(function() {
          numVisits = numVisitsByTime(getVisits(), TimeScale.MONTH);
          updateNumVisitsData(0, 12);
          $('#chart_title').html('Number of Visits per Month');
        });
        $('#yearScale').click(function() {
          numVisits = numVisitsByTime(getVisits(), TimeScale.YEAR);
          updateNumVisitsData(2007, 2012);
          $('#chart_title').html('Number of Visits per Year');
        });
      </script>
      <div id="results">
      </div>
    </div>
    <script type="text/javascript">
      function initFunc() {
        $('span').attr('class', 'protovisGraph');
        $('span').each(function(index) {
          if(index == 0) { $(this).attr('id', 'graph_time'); }
          else if(index == 1) { $(this).attr('id', 'graph_topDomains'); }
          else if(index == 2) { $(this).attr('id', 'graph_focus'); }
          else if(index == 3) { $(this).attr('id', 'graph_pings'); }
        });
        
        /*
        //time num visits graph
        $('#graph_time').appendTo('#container');
        $('#container').append('<p>(Todo: Axes must change when data changes)<\/p>');
        
        //spotlight focus graph
        $('#container').append('<div class="chart_title" style="margin-top:20px">Focus Graph: Spotlight on <a href="javascript:void(0)">reddit.com<\/a><\/div>');
        $('#container').append('<div>Hourly Usage<\/div>');
        $('#graph_focus').appendTo('#container');
        
        //top domains graph
        $('#container').append('<div class="chart_title" style="margin-top:20px">Top Domains<\/div>');
        $('#graph_topDomains').appendTo('#container');
        
        //pings graph
        $('#container').append('<div class="chart_title" style="margin-top:20px">Comparison of Visits to <a href="javascript:void(0)">reddit.com<\/a> and <a href="javascript:void(0)">mail.google.com<\/a><\/div>');
        $('#container').append('<div id="pings_date">Visits for DATE<\/div>');
        $(' graph_pings').appendTo('#container');
        */

        $('#loading').hide();
        $('#container').show();
      }
      //setTimeout("initFunc();", 500);
    </script>
  </body>
</html>
